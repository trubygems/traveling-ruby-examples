name: Package

on:
  push:


jobs:
  package:
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
    - uses: ruby/setup-ruby@v1.267.0
      with:
        ruby-version: 3.4.7
        # bundler-cache: true
    # - name: Install dependencies
    #   run: bundle install --jobs 4 --retry 3
    - name: Build
      run: rake package
      env:
        WITH_NATIVE_EXT: true
    - name: Show standalone packages
      run: ls pkg
    - name: Upload standalone packages
      uses: actions/upload-artifact@v4
      with:
        name: pkg
        path: pkg
  test:
    defaults:
      run:
        shell: bash
    needs: [package]
    strategy:
      fail-fast: false
      matrix:
        os: ["windows-latest", "macos-latest", "ubuntu-latest"]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
    - name: Download all workflow run artifacts
      uses: actions/download-artifact@v4
    - name: test ${{ matrix.os }} package
      run: ./script/unpack-and-test.sh
  test-win-arm:
    defaults:
      run:
        shell: bash
    needs: [package]
    strategy:
      fail-fast: false
      matrix:
        os: ["windows-11-arm"]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v5
    - name: Download all workflow run artifacts
      uses: actions/download-artifact@v4
    - name: test ${{ matrix.os }} package
      run: ./script/unpack-and-test.sh
      env:
        BINARY_ARCH: arm64
        BINARY_OS: windows

  test-linux-musl:
    needs: [package]
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    steps:
    - uses: actions/checkout@v5
    - name: Install dependencies
      run: apk add --no-cache bash curl
    - name: Download all workflow run artifacts
      uses: actions/download-artifact@v4
    - name: test musl package
      run: ./script/unpack-and-test.sh
      env:
        BINARY_ARCH: x86_64
        BINARY_OS: linux-musl

  test-linux-musl-arm:
    needs: [package]
    runs-on: ubuntu-22.04-arm
    steps:
    - uses: actions/checkout@v5
    - name: Download all workflow run artifacts
      uses: actions/download-artifact@v4
    - name: Test in alpine container
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/workspace" \
          -e BINARY_ARCH=arm64 \
          -e BINARY_OS=linux-musl \
          alpine:latest /bin/sh -c "
            apk add --no-cache bash curl && \
            cd /workspace && \
            ./script/unpack-and-test.sh
          "
